# Rerank é‡æ’åºåŠŸèƒ½è¯´æ˜

## ä¸€ã€ä»€ä¹ˆæ˜¯ Rerankï¼Ÿ

**Rerankï¼ˆé‡æ’åºï¼‰**æ˜¯åœ¨åˆæ­¥æ£€ç´¢ç»“æœçš„åŸºç¡€ä¸Šï¼Œä½¿ç”¨æ›´ç²¾ç¡®çš„æ¨¡å‹é‡æ–°è¯„ä¼°æ¯ä¸ªæ–‡æ¡£ä¸æŸ¥è¯¢çš„ç›¸å…³æ€§ï¼Œå¹¶é‡æ–°æ’åºã€‚

### å·¥ä½œæµç¨‹ï¼š
```
ç”¨æˆ·æŸ¥è¯¢ â†’ elastic_searchï¼ˆåˆæ­¥æ£€ç´¢ï¼ŒBM25+å‘é‡+RRFï¼‰ 
        â†’ rerankï¼ˆç”¨ä¸“é—¨æ¨¡å‹é‡æ–°è¯„åˆ†ï¼‰ 
        â†’ è¿”å›æœ€ç›¸å…³çš„ç»“æœ
```

## äºŒã€ä¸ºä»€ä¹ˆéœ€è¦ Rerankï¼Ÿ

### é—®é¢˜ï¼š
- **åˆæ­¥æ£€ç´¢ä¸å¤Ÿç²¾ç¡®**ï¼šBM25 å’Œå‘é‡æ£€ç´¢å¯èƒ½æŠŠä¸ç›¸å…³ä½†åŒ…å«å…³é”®è¯çš„å†…å®¹æ’åˆ°å‰é¢
- **ä¾‹å¦‚**ï¼šæŸ¥è¯¢"ç¬¬ä¸€ç«  ä»»åŠ¡å’ŒåŸºæœ¬åŸåˆ™"ï¼Œå¯èƒ½æ£€ç´¢åˆ°ç¬¬9é¡µï¼ˆåªåŒ…å«"ç¬¬ä¸€ç« "å…³é”®è¯ä½†ä¸ç›¸å…³ï¼‰

### è§£å†³æ–¹æ¡ˆï¼š
- **Reranker æ¨¡å‹**ï¼šä¸“é—¨è®­ç»ƒç”¨äºè¯„ä¼° query-document ç›¸å…³æ€§çš„æ¨¡å‹
- **æ›´ç²¾ç¡®**ï¼šèƒ½ç†è§£è¯­ä¹‰ï¼Œåˆ¤æ–­æ–‡æ¡£æ˜¯å¦çœŸçš„å›ç­”æŸ¥è¯¢é—®é¢˜

## ä¸‰ã€ä»£ç å®ç°åŸç†

### 1. å…¥å£å‡½æ•°ï¼š`rerank(query, result_doc)`
```python
def rerank(query, result_doc):
    """è°ƒç”¨é‡æ’åºæœåŠ¡"""
    # ä¼˜å…ˆä½¿ç”¨æœ¬åœ°æ¨¡å‹
    try:
        return _qwen_rerank(query, result_doc)  # æœ¬åœ°
    except ImportError:
        return _remote_rerank(query, result_doc)  # è¿œç¨‹æœåŠ¡
```

### 2. æœ¬åœ°å®ç°ï¼š`_qwen_rerank(query, result_doc)`

**æ­¥éª¤ 1ï¼šåŠ è½½æ¨¡å‹ï¼ˆé¦–æ¬¡è°ƒç”¨ï¼‰**
```python
model_name = "Qwen/Qwen3-Reranker-0.6B"
_reranker_model = AutoModelForSequenceClassification.from_pretrained(model_name)
_reranker_model.eval()  # è®¾ç½®ä¸ºè¯„ä¼°æ¨¡å¼
```

**æ­¥éª¤ 2ï¼šå¯¹æ¯ä¸ªæ–‡æ¡£è®¡ç®—ç›¸å…³æ€§åˆ†æ•°**
```python
scores = []
for doc in result_doc:
    # æ„å»º query-document å¯¹
    pairs = [[query, doc.get('text', '')]]
    
    # Tokenizeï¼ˆè½¬æ¢ä¸ºæ¨¡å‹è¾“å…¥æ ¼å¼ï¼‰
    inputs = _reranker_tokenizer(pairs, padding=True, truncation=True, max_length=512)
    
    # æ¨¡å‹æ¨ç†ï¼ˆè®¡ç®—ç›¸å…³æ€§åˆ†æ•°ï¼‰
    outputs = _reranker_model(**inputs)
    score = outputs.logits[0][0].item()  # å¾—åˆ°åˆ†æ•°ï¼ˆæ•°å€¼è¶Šå¤§è¶Šç›¸å…³ï¼‰
    scores.append(score)
```

**æ­¥éª¤ 3ï¼šæŒ‰åˆ†æ•°é‡æ–°æ’åº**
```python
# æ›´æ–°æ¯ä¸ªæ–‡æ¡£çš„åˆ†æ•°
for idx, doc in enumerate(result_doc):
    result_doc[idx]['score'] = scores[idx]

# æŒ‰åˆ†æ•°é™åºæ’åºï¼ˆåˆ†æ•°é«˜çš„åœ¨å‰ï¼‰
result_doc.sort(key=lambda x: (-x.get('score', 0), x.get('id', '')))

# æ›´æ–° rank å­—æ®µ
for idx, doc in enumerate(result_doc):
    result_doc[idx]['rank'] = idx + 1
```

## å››ã€ä½¿ç”¨æ–¹å¼

### æ–¹å¼ 1ï¼šåœ¨ä»£ç ä¸­è°ƒç”¨
```python
from retrieve_documents import elastic_search, rerank

# 1. åˆæ­¥æ£€ç´¢
results = elastic_search('ç¬¬ä¸€ç«  ä»»åŠ¡å’ŒåŸºæœ¬åŸåˆ™', 'test_index_1')

# 2. é‡æ’åºï¼ˆå–å‰20ä¸ªå€™é€‰ï¼‰
results = rerank('ç¬¬ä¸€ç«  ä»»åŠ¡å’ŒåŸºæœ¬åŸåˆ™', results[:20])

# 3. æŸ¥çœ‹å‰5ä¸ªç»“æœ
for r in results[:5]:
    print(f"#{r['rank']}: {r['text'][:100]}")
```

### æ–¹å¼ 2ï¼šå‘½ä»¤è¡Œå‚æ•°
```bash
# ä½¿ç”¨ rerank
python run.py --index test_index_1 --query "ç¬¬ä¸€ç«  ä»»åŠ¡å’ŒåŸºæœ¬åŸåˆ™" --top_k 5 --rerank

# ä¸ä½¿ç”¨ rerankï¼ˆåªç”¨ RRF æ··åˆæ£€ç´¢ï¼‰
python run.py --index test_index_1 --query "ç¬¬ä¸€ç«  ä»»åŠ¡å’ŒåŸºæœ¬åŸåˆ™" --top_k 5
```

## äº”ã€æ³¨æ„äº‹é¡¹

### âœ… ä¼˜ç‚¹ï¼š
- **æ›´ç²¾ç¡®**ï¼šèƒ½è¯†åˆ«çœŸæ­£ç›¸å…³çš„æ–‡æ¡£
- **è¯­ä¹‰ç†è§£**ï¼šç†è§£æŸ¥è¯¢æ„å›¾ï¼Œä¸ä»…ä»…æ˜¯å…³é”®è¯åŒ¹é…

### âš ï¸ ç¼ºç‚¹ï¼š
- **å¯èƒ½ä¸ç¨³å®š**ï¼šè¿œç¨‹æœåŠ¡æˆ–æ¨¡å‹æ¨ç†å¯èƒ½æœ‰éç¡®å®šæ€§
- **é€Ÿåº¦è¾ƒæ…¢**ï¼šéœ€è¦å¯¹æ¯ä¸ªæ–‡æ¡£è¿›è¡Œæ¨¡å‹æ¨ç†
- **æˆæœ¬è¾ƒé«˜**ï¼šéœ€è¦é¢å¤–çš„è®¡ç®—èµ„æº

### ğŸ’¡ å»ºè®®ï¼š
- **ä¼˜å…ˆä½¿ç”¨ RRF æ··åˆæ£€ç´¢**ï¼ˆä¸åŠ  --rerankï¼‰ï¼Œé€šå¸¸å·²è¶³å¤Ÿå‡†ç¡®ä¸”ç¨³å®š
- **éœ€è¦æ›´é«˜ç²¾åº¦æ—¶**å†ä½¿ç”¨ rerankï¼Œä½†è¦æ³¨æ„ç¨³å®šæ€§é—®é¢˜

## å…­ã€æ¨¡å‹é€‰æ‹©

ä»£ç æ”¯æŒä¸¤ç§æ–¹å¼ï¼š
1. **æœ¬åœ°æ¨¡å‹**ï¼š`Qwen3-Reranker-0.6B`ï¼ˆéœ€è¦ä¸‹è½½ï¼Œé¦–æ¬¡è¿è¡Œè¾ƒæ…¢ï¼‰
2. **è¿œç¨‹æœåŠ¡**ï¼šé€šè¿‡ `RERANK_URL` è°ƒç”¨ï¼ˆéœ€è¦é…ç½® `config.py`ï¼‰

ä»£ç ä¼šè‡ªåŠ¨é€‰æ‹©ï¼šä¼˜å…ˆæœ¬åœ°ï¼Œå¤±è´¥åˆ™ä½¿ç”¨è¿œç¨‹ã€‚

